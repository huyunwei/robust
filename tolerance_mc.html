<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monte Carlo Simulation Input</title>
</head>
<body>
    <h2>Enter Number of Variables (X)</h2>
    <input type="number" id="numX" placeholder="Number of X">
    <button onclick="generateTable()">Generate Table</button>

    <h2>Input Data</h2>
    <table border="1" id="inputTable"></table>
    <br>
    <label for="transferFunction">Transfer Function (use variables as their names from table): </label>
    <input type="text" id="transferFunction" placeholder="e.g., a + 2*b">
    <br><br>
    <button onclick="simulate()">Run Simulation</button>
    
    <h2>Results</h2>
    <pre id="results"></pre>

    <script>
    function generateTable() {
        const numX = parseInt(document.getElementById("numX").value);
        const table = document.getElementById("inputTable");
    
    // Clear the table first
    while (table.firstChild) {
        table.removeChild(table.firstChild);
    }

    // Create table header
    let thead = table.createTHead();
    let headerRow = thead.insertRow();
    let columns = ["Name", "Nominal", "Upper_tol", "Lower_Tol", "Sigma Level"]; // Added Lower_Tol
    for (let col of columns) {
        let th = document.createElement("th");
        th.textContent = col;
        headerRow.appendChild(th);
    }

    // Create rows based on numX input
    for (let i = 0; i < numX; i++) {
        let row = table.insertRow();
        for (let j = 0; j < columns.length; j++) {
            let cell = row.insertCell();
            let input = document.createElement("input");
            input.type = "text";
            cell.appendChild(input);
        }
    }
}
        

        function simulate() {
            const table = document.getElementById("inputTable");
            const transferFunction = document.getElementById("transferFunction").value;
            let data = [];
            let variableDict = {};
            // Extract data from table
            for (let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const name = row.cells[0].firstChild.value;
                const nominal = parseFloat(row.cells[1].firstChild.value);
                const upper_tol = parseFloat(row.cells[2].firstChild.value);
                const lower_tol = parseFloat(row.cells[3].firstChild.value);
                const sigma_level = parseFloat(row.cells[4].firstChild.value);
                
                const max = nominal + upper_tol;
                const min = nominal + lower_tol;
                const mean = (max + min) / 2;
                const std = (max - min) / 2 / sigma_level;
                data.push({
                    name: name,
                    mean: mean,
                    std: std    });
        // Populate the variable dictionary for transfer function
        //variableDict[name] = normalRandom(mean, std);
}

    let results = [];
    const N_SIM = 1000000; // The number of simulation runs
    // Iterate for the number of simulations
    for (let sim = 0; sim < N_SIM; sim++) {
        let simulationResult = {};
        // For each simulation run, generate a new set of random values for each variable
        for (const entry of data) {
            simulationResult[entry.name] = normalRandom(entry.mean, entry.std);
        }
        
        // Evaluate the transfer function with the new set of random values
        let evalResult = evalTransferFunction(transferFunction, simulationResult);
        results.push(evalResult);
    }

    // Compute statistics from the simulation results
    let stats = computeStatistics(results);
    document.getElementById("results").textContent = JSON.stringify(stats, null, 2);
}

        function evalTransferFunction(func, variables) {
            with (variables) {
                return eval(func);
            }
        }

        function computeStatistics(data) {
            let sum = data.reduce((a, b) => a + b, 0);
            let mean = sum / data.length;
            
            let squaredDiff = data.map(value => Math.pow(value - mean, 2));
            let std = Math.sqrt(squaredDiff.reduce((a, b) => a + b, 0) / data.length);
            
            let sortedData = data.slice().sort((a, b) => a - b);
            
            return {
                mean: mean,
                std: std,
                p1: sortedData[Math.floor(data.length * 0.01)],
                p5: sortedData[Math.floor(data.length * 0.05)],
                p25: sortedData[Math.floor(data.length * 0.25)],
                p50: sortedData[Math.floor(data.length * 0.50)],
                p75: sortedData[Math.floor(data.length * 0.75)],
                p95: sortedData[Math.floor(data.length * 0.95)],
                p99: sortedData[Math.floor(data.length * 0.99)]
            };
        }

        function normalRandom(mean, stddev) {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            return mean + stddev * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }
    </script>
</body>
</html>
